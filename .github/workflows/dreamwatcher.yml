name: Dreamwatcher

on:
  schedule:
    - cron: '*/10 * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  monitor:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v3

      - name: Fetch state.json from state branch
        run: |
          git fetch origin state:state --force || true
          if git rev-parse --verify state >/dev/null 2>&1; then
            git show state:state.json > state.json || echo '{"seen": {}, "updated_at": null, "content_hashes": {}}' > state.json
          else
            echo '{"seen": {}, "updated_at": null, "content_hashes": {}}' > state.json
          fi

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run Dreamwatcher
        env:
          WIKIWIKI_ID: ${{ secrets.WIKIWIKI_ID }}
          WIKIWIKI_URL_BASE: ${{ vars.WIKIWIKI_URL_BASE }}
          WIKIWIKI_API_KEY_ID: ${{ secrets.WIKIWIKI_API_KEY_ID }}
          WIKIWIKI_API_SECRET: ${{ secrets.WIKIWIKI_API_SECRET }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          WIKIWIKI_PAGE_NAMES: ${{ vars.WIKIWIKI_PAGE_NAMES }}
          STATE_PATH: ${{ vars.STATE_PATH }}
        run: python -m dreamwatcher.main

      - name: Push state.json to state branch
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"

          if git rev-parse --verify state >/dev/null 2>&1; then
            # state branch exists, compare with its previous version
            if git diff --quiet state -- state.json; then
              echo "No changes to state.json, skipping commit"
              exit 0
            fi
          fi

          git checkout -B state
          git add state.json
          git commit -m "Update state.json"
          git push origin state --force

          git checkout main