name: Dreamwatcher

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  monitor:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v3

      - name: Fetch state.json and snapshots.json from state branch
        run: |
          git fetch origin state:state --force || true
          if git rev-parse --verify state >/dev/null 2>&1; then
            git show state:state.json > state.json || echo '{"seen": {}, "updated_at": null, "content_hashes": {}}' > state.json
            mkdir -p .snapshots
            git show state:.snapshots/snapshots.json > .snapshots/snapshots.json || echo '{}' > .snapshots/snapshots.json
          else
            echo '{"seen": {}, "updated_at": null, "content_hashes": {}}' > state.json
            mkdir -p .snapshots
            echo '{}' > .snapshots/snapshots.json
          fi

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run Dreamwatcher
        env:
          WIKIWIKI_ID: ${{ secrets.WIKIWIKI_ID }}
          WIKIWIKI_URL_BASE: ${{ vars.WIKIWIKI_URL_BASE }}
          WIKIWIKI_API_KEY_ID: ${{ secrets.WIKIWIKI_API_KEY_ID }}
          WIKIWIKI_API_SECRET: ${{ secrets.WIKIWIKI_API_SECRET }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          WIKIWIKI_PAGE_NAMES: ${{ vars.WIKIWIKI_PAGE_NAMES }}
          WIKIWIKI_AUTO_TRACK_PATTERN: ${{ vars.WIKIWIKI_AUTO_TRACK_PATTERN }}
          STATE_PATH: ${{ vars.STATE_PATH }}
        run: python -m dreamwatcher.main

      - name: Push state.json and snapshots.json to state branch
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"

          has_state_changes=0
          has_snapshot_changes=0

          if git rev-parse --verify state >/dev/null 2>&1; then
            if git diff state -- state.json | grep -q .; then
              has_state_changes=1
            fi
            if git diff state -- .snapshots/snapshots.json | grep -q .; then
              has_snapshot_changes=1
            fi
          else
            has_state_changes=1
            has_snapshot_changes=1
          fi

          if [ "$has_state_changes" -eq 1 ] || [ "$has_snapshot_changes" -eq 1 ]; then
            git checkout -B state
            git add state.json .snapshots/snapshots.json
            if [ "$has_state_changes" -eq 1 ] && [ "$has_snapshot_changes" -eq 1 ]; then
              git commit -m "Update state.json and snapshots.json"
            elif [ "$has_state_changes" -eq 1 ]; then
              git commit -m "Update state.json"
            else
              git commit -m "Update snapshots.json"
            fi
            git push origin state --force
          else
            echo "No changes to state.json or snapshots.json, skipping commit"
          fi

          git checkout main